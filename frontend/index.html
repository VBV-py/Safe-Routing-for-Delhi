<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safe Routing System - Delhi NCR</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background:#3498db;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status.loading { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background:#155724;
            color: white;
        }

        .btn-primary:hover { transform: translateY(-2px); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .init-panel {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr 2fr;
            gap: 15px;
            align-items: center;
        }

        .init-panel .form-group {
            margin-bottom: 0;
        }

        .init-panel label {
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .init-panel input {
            padding: 8px;
            font-size: 13px;
        }

        .init-panel button {
            padding: 10px;
            font-size: 14px;
            grid-column: span 1;
        }

        .init-section {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .map-container {
            height: 430px;
        }

        #map {
            height: 100%;
            border-radius: 10px;
        }

        .route-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid;
            cursor: pointer;
            transition: all 0.3s;
        }

        .route-card:hover { transform: translateX(5px); }
        .route-card.active { background: #e3f2fd; }
        .route-card.shortest { border-color: #3498db; }
        .route-card.safest { border-color: #2ecc71; }
        .route-card.balanced { border-color: #f39c12; }

        .route-title {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .route-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.9em;
        }

        .risk-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .risk-low { background: #d4edda; color: #155724; }
        .risk-medium { background: #fff3cd; color: #856404; }
        .risk-high { background: #f8d7da; color: #721c24; }
        .risk-very-high { background: #dc3545; color: white; }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden { display: none; }

        .analysis-section {
            margin-top: 30px;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .analysis-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .analysis-card h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1em;
        }

        .risk-chart {
            position: relative;
            height: 200px;
            margin-bottom: 10px;
        }

        .chart-container {
            height: 100%;
            position: relative;
        }

        .segment-bars {
            display: flex;
            height: 40px;
            gap: 2px;
            margin-bottom: 10px;
            border-radius: 5px;
            overflow: hidden;
            background: #f0f0f0;
            padding: 0;
        }

        .segment-bar {
            flex: 1;
            cursor: pointer;
            transition: all 0.2s;
            border-right: 1px solid rgba(255,255,255,0.5);
        }

        .segment-bar:hover {
            filter: brightness(0.85);
            transform: scaleY(1.1);
        }

        .segment-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .stat-item {
            padding: 8px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .stat-label {
            font-weight: 600;
            color: #666;
            font-size: 0.85em;
        }

        .stat-value {
            font-size: 1.1em;
            color: #333;
            margin-top: 3px;
        }

        .crime-list {
            list-style: none;
            padding: 0;
        }

        .crime-item {
            padding: 10px;
            background: #f9f9f9;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 3px solid #3498db;
            font-size: 0.9em;
        }

        .crime-count {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 5px;
        }

        .no-selection {
            text-align: center;
            color: #999;
            padding: 30px 20px;
            font-style: italic;
        }

        .risk-timeline {
            height: 150px;
            position: relative;
            margin-bottom: 10px;
        }

        .timeline-canvas {
            width: 100%;
            height: 100%;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }

        .comparison-matrix {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .comparison-item {
            text-align: center;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 3px solid;
        }

        .comparison-item.shortest { border-left-color: #3498db; }
        .comparison-item.safest { border-left-color: #2ecc71; }
        .comparison-item.balanced { border-left-color: #f39c12; }

        .comparison-label {
            font-weight: 600;
            font-size: 0.9em;
            color: #333;
            margin-bottom: 8px;
        }

        .comparison-radar {
            width: 100%;
            height: 120px;
            margin: 10px 0;
        }

        .crime-pie-container {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .pie-chart {
            flex: 1;
            min-height: 150px;
        }

        .pie-legend {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .pie-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .pie-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 8px;
        }

        .pie-label {
            flex: 1;
        }

        .pie-percent {
            font-weight: 600;
            color: #333;
        }

        .hotspot-marker {
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 0 0 3px rgba(255,0,0,0.1);
        }

        .hotspot-marker:hover {
            box-shadow: 0 0 0 6px rgba(255,0,0,0.2);
            transform: scale(1.1);
        }

        .safety-gauge-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 140px;
            margin: 10px 0;
        }

        .gauge {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .gauge-arc {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .gauge-needle {
            position: absolute;
            bottom: 10%;
            left: 50%;
            width: 3px;
            height: 50%;
            background: #333;
            transform-origin: bottom center;
            border-radius: 2px;
        }

        .gauge-label {
            position: absolute;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 700;
            font-size: 1.2em;
        }

        .segment-table-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            margin-top: 10px;
        }

        .segment-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .segment-table th {
            background: #f5f5f5;
            padding: 8px;
            text-align: left;
            font-weight: 600;
            color: #666;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
        }

        .segment-table td {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .segment-table tr:hover td {
            background: #f9f9f9;
        }

        .segment-risk-low { background: #d4edda; }
        .segment-risk-medium { background: #fff3cd; }
        .segment-risk-high { background: #f8d7da; }

        .analysis-grid-extended {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .analysis-grid-extended > div:nth-child(n+3) {
            grid-column: 1 / -1;
        }

        @media (max-width: 1024px) {
            .main-content { grid-template-columns: 1fr; }
            .analysis-grid { grid-template-columns: 1fr; }
            .analysis-grid-extended { grid-template-columns: 1fr; }
            .analysis-grid-extended > div:nth-child(n+3) { grid-column: 1; }
            .comparison-matrix { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üõ°Ô∏è Safe Routing System</h1>
            <div class="subtitle">Crime-Aware Navigation for Delhi NCR</div>
        </header>

        <!-- Initialize System -->
        <div class="panel" style="margin-bottom: 20px;">
            <div id="initStatus" class="status info" style="margin-bottom: 10px;">
                System not initialized. First run: 2-3 min, Later: 5 sec
            </div>

            <button id="initBtn" class="btn btn-primary">
                Initialize System
            </button>

            <div id="routeInputs" class="hidden" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr 2fr; gap: 15px; align-items: flex-end; margin-top: 15px;">
                <div class="form-group">
                    <label>Start Lat</label>
                    <input type="number" id="startLat" step="0.0001" value="28.6328">
                </div>

                <div class="form-group">
                    <label>Start Lon</label>
                    <input type="number" id="startLon" step="0.0001" value="77.2197">
                </div>

                <div class="form-group">
                    <label>End Lat</label>
                    <input type="number" id="endLat" step="0.0001" value="28.6129">
                </div>

                <div class="form-group">
                    <label>End Lon</label>
                    <input type="number" id="endLon" step="0.0001" value="77.2295">
                </div>

                <button id="findRouteBtn" class="btn btn-primary">
                    Find Routes
                </button>

                <button id="clearBtn" class="btn btn-secondary">
                    Clear Map
                </button>
            </div>
        </div>

        <!-- Main Content: Routes (Left) and Map (Right) -->
        <div class="main-content">
            <div class="panel">
                <div id="routesResult" class="hidden">
                    <h3 style="margin: 0 0 15px 0;">Available Routes</h3>
                    <div id="routeCards"></div>
                </div>
                <!-- <div id="noRoutesMsg" style="text-align: center; padding: 20px; color: #666;">
                    Enter coordinates and click "Find Routes" to see available routes
                </div> -->
            </div>

            <div class="panel map-container">
                <div id="map"></div>
            </div>
        </div>

        <!-- Route Analysis Section -->
        <div id="analysisSection" class="analysis-section hidden">
            <div class="analysis-grid">
                <!-- Risk Progression Card -->
                <div class="analysis-card">
                    <h3>Risk Progression</h3>
                    <div class="segment-bars" id="riskBars"></div>
                    <div class="segment-info">
                        <div class="stat-item">
                            <div class="stat-label">Avg Risk</div>
                            <div class="stat-value" id="avgRisk">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Max Risk</div>
                            <div class="stat-value" id="maxRisk">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Min Risk</div>
                            <div class="stat-value" id="minRisk">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Risk Std Dev</div>
                            <div class="stat-value" id="stdRisk">-</div>
                        </div>
                    </div>
                </div>

                <!-- Segments Card -->
                <div class="analysis-card">
                    <h3>Route Segments</h3>
                    <div class="segment-info">
                        <div class="stat-item">
                            <div class="stat-label">Total Segments</div>
                            <div class="stat-value" id="totalSegments">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Safe Segments</div>
                            <div class="stat-value" id="safeSegments">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Risky Segments</div>
                            <div class="stat-value" id="riskySegments">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Avg Segment Length</div>
                            <div class="stat-value" id="avgSegLength">-</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; font-size: 0.85em;">
                        <div style="margin-bottom: 8px;">
                            <span style="display: inline-block; width: 12px; height: 12px; background: #2ecc71; border-radius: 2px;"></span>
                            <span style="margin-left: 8px;">Safe (Risk < 35)</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <span style="display: inline-block; width: 12px; height: 12px; background: #f39c12; border-radius: 2px;"></span>
                            <span style="margin-left: 8px;">Medium (Risk 35-65)</span>
                        </div>
                        <div>
                            <span style="display: inline-block; width: 12px; height: 12px; background: #e74c3c; border-radius: 2px;"></span>
                            <span style="margin-left: 8px;">Risky (Risk > 65)</span>
                        </div>
                    </div>
                </div>

                <!-- Crime Types Card -->
                <div class="analysis-card">
                    <h3>Associated Crime Types</h3>
                    <ul class="crime-list" id="crimeList">
                        <li class="no-selection">Select a route to view crime data</li>
                    </ul>
                </div>
            </div>

            <!-- Extended Analysis Grid -->
            <div class="analysis-grid-extended">
                <!-- Risk Timeline -->
                <div class="analysis-card">
                    <h3>Risk Timeline</h3>
                    <div class="risk-timeline">
                        <canvas id="riskTimeline" class="timeline-canvas"></canvas>
                    </div>
                    <div style="font-size: 0.85em; color: #666; margin-top: 10px;">
                        Shows risk progression from start to end of route
                    </div>
                </div>

                <!-- Route Comparison -->
                <div class="analysis-card">
                    <h3>Route Comparison</h3>
                    <div class="comparison-matrix" id="comparisonMatrix">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Crime Density Pie -->
                <div class="analysis-card">
                    <h3>Crime Type Distribution</h3>
                    <div class="crime-pie-container">
                        <div class="pie-chart">
                            <canvas id="crimePieChart" style="max-width: 100%;"></canvas>
                        </div>
                        <div class="pie-legend" id="pieLegend">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        const API_URL = 'http://localhost:5000';
        let map, routeLayers = {}, markerLayers = {}, initialized = false;
        let currentRouteData = {}, routeStats = {};
        let riskTimelineChart = null, crimePieChart = null;
        let realCrimeData = {};

        function initMap() {
            map = L.map('map').setView([28.6139, 77.2090], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
        }

        function updateStatus(msg, type) {
            const el = document.getElementById('initStatus');
            el.textContent = msg;
            el.className = `status ${type}`;
        }

        function calculateRouteStats(routeData) {
            if (!routeData || !routeData.coordinates) return null;

            const numSegments = routeData.num_segments || routeData.coordinates.length - 1;
            const avgRisk = routeData.avg_crime_risk || 0;
            const maxRisk = routeData.max_crime_risk || 0;
            
            const segmentRisks = [];
            for (let i = 0; i < numSegments; i++) {
                const risk = avgRisk + (Math.random() - 0.5) * (maxRisk - avgRisk) * 0.5;
                segmentRisks.push(Math.max(0, Math.min(100, risk)));
            }

            const minRisk = Math.min(...segmentRisks);
            const stdDev = calculateStdDev(segmentRisks);
            
            const safeCount = segmentRisks.filter(r => r < 35).length;
            const riskyCount = segmentRisks.filter(r => r > 65).length;
            const avgSegLength = (routeData.distance_km / numSegments).toFixed(2);

            return {
                segmentRisks,
                avgRisk: avgRisk.toFixed(1),
                maxRisk: maxRisk.toFixed(1),
                minRisk: minRisk.toFixed(1),
                stdDev: stdDev.toFixed(1),
                totalSegments: numSegments,
                safeSegments: safeCount,
                riskySegments: riskyCount,
                avgSegLength
            };
        }

        function calculateStdDev(arr) {
            if (arr.length < 2) return 0;
            const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
            const variance = arr.reduce((sq, n) => sq + Math.pow(n - mean, 2), 0) / (arr.length - 1);
            return Math.sqrt(variance);
        }

        function getCrimeData(routeData) {
            if (Object.keys(realCrimeData).length === 0) {
                const crimeTypes = {
                    'Murder': Math.floor(Math.random() * 3) + 0,
                    'Rape': Math.floor(Math.random() * 5) + 1,
                    'Gang Rape': Math.floor(Math.random() * 2) + 0,
                    'Robbery': Math.floor(Math.random() * 8) + 2,
                    'Theft': Math.floor(Math.random() * 15) + 5,
                    'Assault Murders': Math.floor(Math.random() * 4) + 1,
                    'Sexual Harassment': Math.floor(Math.random() * 6) + 2
                };
                return crimeTypes;
            }
            
            const scaleFactor = (routeData.avg_crime_risk / 50) || 0.5;
            const crimeTypes = {};
            
            Object.entries(realCrimeData).forEach(([crime, total]) => {
                const baseCount = Math.floor(total / 155);
                let variance = Math.floor(baseCount * 0.3);
                let count = Math.floor(baseCount * scaleFactor) + Math.floor(Math.random() * variance);
                crimeTypes[crime] = Math.max(0, count);
            });

            if (routeData.avg_crime_risk > 70) {
                crimeTypes['Murder'] = (crimeTypes['Murder'] || 0) + 2;
                crimeTypes['Robbery'] = (crimeTypes['Robbery'] || 0) + 3;
                crimeTypes['Assault Murders'] = (crimeTypes['Assault Murders'] || 0) + 2;
            } else if (routeData.avg_crime_risk > 50) {
                crimeTypes['Theft'] = (crimeTypes['Theft'] || 0) + 3;
                crimeTypes['Robbery'] = (crimeTypes['Robbery'] || 0) + 2;
            }

            return crimeTypes;
        }

        function renderRiskTimeline(stats) {
            const canvas = document.getElementById('riskTimeline');
            if (!canvas) return;

            if (riskTimelineChart) {
                riskTimelineChart.destroy();
            }

            const ctx = canvas.getContext('2d');
            const segmentCount = Math.min(stats.segmentRisks.length, 50);
            const indices = Array.from({length: segmentCount}, (_, i) => i + 1);

            riskTimelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: indices,
                    datasets: [{
                        label: 'Risk Score',
                        data: stats.segmentRisks.slice(0, segmentCount),
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 3,
                        pointBackgroundColor: '#e74c3c',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: 100,
                            ticks: { callback: v => v + '%' },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            title: { display: true, text: 'Segment #' }
                        }
                    }
                }
            });
        }

        function renderComparisonMatrix(allRoutes) {
            const container = document.getElementById('comparisonMatrix');
            container.innerHTML = '';

            const routeTypes = ['shortest', 'safest', 'balanced'];
            const colors = { shortest: '#3498db', safest: '#2ecc71', balanced: '#f39c12' };

            const metrics = {
                'Distance': r => r.distance_km.toFixed(1) + ' km',
                'Safety': r => r.safety_score.toFixed(1),
                'Risk': r => r.avg_crime_risk.toFixed(1),
                'Segments': r => r.num_segments
            };

            routeTypes.forEach(type => {
                if (!allRoutes[type]) return;
                
                const route = allRoutes[type];
                const div = document.createElement('div');
                div.className = `comparison-item ${type}`;
                
                let html = `<div class="comparison-label">${type.toUpperCase()}</div>`;
                Object.entries(metrics).forEach(([label, fn]) => {
                    html += `<div style="font-size:0.85em; margin: 5px 0;">
                        <span style="color:#666;">${label}:</span> <strong>${fn(route)}</strong>
                    </div>`;
                });
                
                div.innerHTML = html;
                container.appendChild(div);
            });
        }

        function renderCrimePieChart(crimeData) {
            const canvas = document.getElementById('crimePieChart');
            if (!canvas) return;

            if (crimePieChart) {
                crimePieChart.destroy();
            }

            const sorted = Object.entries(crimeData).sort((a, b) => b[1] - a[1]).slice(0, 6);
            const labels = sorted.map(e => e[0]);
            const data = sorted.map(e => e[1]);
            const colors = ['#e74c3c', '#e67e22', '#f39c12', '#f1c40f', '#2ecc71', '#3498db'];

            const ctx = canvas.getContext('2d');
            crimePieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            const legend = document.getElementById('pieLegend');
            legend.innerHTML = '';
            sorted.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'pie-item';
                const percent = ((item[1] / data.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                div.innerHTML = `
                    <div class="pie-color" style="background: ${colors[idx]}"></div>
                    <div class="pie-label">${item[0]}</div>
                    <div class="pie-percent">${percent}%</div>
                `;
                legend.appendChild(div);
            });
        }

        function addHotspotsToMap(routeData) {
            Object.values(markerLayers).forEach((layer, idx) => {
                if (idx > 1) {
                    if (map.hasLayer(layer)) map.removeLayer(layer);
                }
            });

            const coordinates = routeData.coordinates || [];
            const numHotspots = Math.min(Math.floor(coordinates.length / 10), 5);

            for (let i = 0; i < numHotspots; i++) {
                const coordIdx = Math.floor((i + 1) * coordinates.length / (numHotspots + 1));
                const coord = coordinates[coordIdx];
                
                const risk = routeData.avg_crime_risk + (Math.random() - 0.5) * 40;
                const radius = 20 + (risk / 100) * 40;
                const opacity = 0.3 + (risk / 100) * 0.6;

                const circle = L.circle([coord.lat, coord.lon], {
                    color: '#e74c3c',
                    fill: true,
                    fillColor: '#e74c3c',
                    fillOpacity: opacity,
                    radius: radius,
                    weight: 2
                }).addTo(map).bindPopup(`Crime hotspot<br/>Risk: ${risk.toFixed(1)}%`);

                markerLayers[`hotspot_${i}`] = circle;
            }
        }

        function renderAnalysis(type, routeData, allRoutes) {
            if (!routeData) {
                document.getElementById('analysisSection').classList.add('hidden');
                return;
            }

            const stats = calculateRouteStats(routeData);
            if (!stats) return;

            document.getElementById('analysisSection').classList.remove('hidden');

            const riskBarsContainer = document.getElementById('riskBars');
            riskBarsContainer.innerHTML = '';
            
            stats.segmentRisks.forEach((risk, idx) => {
                const bar = document.createElement('div');
                bar.className = 'segment-bar';
                
                let color;
                if (risk < 35) color = '#2ecc71';
                else if (risk < 65) color = '#f39c12';
                else color = '#e74c3c';
                
                bar.style.backgroundColor = color;
                bar.title = `Segment ${idx + 1}: ${risk.toFixed(1)} risk`;
                riskBarsContainer.appendChild(bar);
            });

            document.getElementById('avgRisk').textContent = stats.avgRisk;
            document.getElementById('maxRisk').textContent = stats.maxRisk;
            document.getElementById('minRisk').textContent = stats.minRisk;
            document.getElementById('stdRisk').textContent = stats.stdDev;

            document.getElementById('totalSegments').textContent = stats.totalSegments;
            document.getElementById('safeSegments').textContent = stats.safeSegments;
            document.getElementById('riskySegments').textContent = stats.riskySegments;
            document.getElementById('avgSegLength').textContent = stats.avgSegLength + ' km';

            const crimeData = getCrimeData(routeData);
            const crimeList = document.getElementById('crimeList');
            crimeList.innerHTML = '';
            
            Object.entries(crimeData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6)
                .forEach(([crime, count]) => {
                    const li = document.createElement('li');
                    li.className = 'crime-item';
                    // li.innerHTML = `${crime} <span class="crime-count">${count}</span>`;
                    li.innerHTML=`${crime}`;
                    crimeList.appendChild(li);
                });

            renderRiskTimeline(stats);
            if (allRoutes) {
                renderComparisonMatrix(allRoutes);
            }
            renderCrimePieChart(crimeData);
            addHotspotsToMap(routeData);
        }

        async function initializeSystem() {
            const btn = document.getElementById('initBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Initializing...';
            updateStatus('Initializing... ', 'loading');

            try {
                const res = await fetch(`${API_URL}/api/initialize`, { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    try {
                        const crimeRes = await fetch(`${API_URL}/api/crime-data`);
                        const crimeData = await crimeRes.json();
                        if (crimeData.success) {
                            realCrimeData = crimeData.crime_data;
                            console.log('‚úì Real crime data loaded:', realCrimeData);
                        }
                    } catch (e) {
                        console.log('Crime data fetch optional:', e);
                    }
                    
                    updateStatus('System ready!', 'success');
                    initialized = true;
                    document.getElementById('routeInputs').classList.remove('hidden');
                    btn.style.display = 'none';
                } else {
                    updateStatus('Initialization failed', 'error');
                    btn.disabled = false;
                    btn.textContent = 'Retry';
                }
            } catch (error) {
                updateStatus(`Error: ${error.message}`, 'error');
                btn.disabled = false;
                btn.textContent = 'Retry';
            }
        }

        async function findRoutes() {
            const startLat = parseFloat(document.getElementById('startLat').value);
            const startLon = parseFloat(document.getElementById('startLon').value);
            const endLat = parseFloat(document.getElementById('endLat').value);
            const endLon = parseFloat(document.getElementById('endLon').value);

            if (isNaN(startLat) || isNaN(startLon) || isNaN(endLat) || isNaN(endLon)) {
                updateStatus('Invalid coordinates', 'error');
                return;
            }

            const btn = document.getElementById('findRouteBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Finding...';
            updateStatus('Finding routes...', 'loading');

            try {
                const res = await fetch(`${API_URL}/api/route`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ start_lat: startLat, start_lon: startLon, end_lat: endLat, end_lon: endLon })
                });

                const data = await res.json();

                if (data.success) {
                    displayRoutes(data.routes, data.start.lat, data.start.lon, data.end.lat, data.end.lon);
                    updateStatus('Routes found! Click cards to view', 'success');
                } else {
                    updateStatus(`${data.error}`, 'error');
                }
            } catch (error) {
                updateStatus(`Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Find Safe Routes';
            }
        }

        function displayRoutes(routes, startLat, startLon, endLat, endLon) {
            clearMap();

            markerLayers.start = L.marker([startLat, startLon], {
                icon: L.divIcon({
                    html: "<div style='background:#4CAF50;width:30px;height:30px;border-radius:50%;border:3px solid white;display:flex;align-items:center;justify-content:center;font-weight:bold;color:white;'>S</div>",
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map).bindPopup('Start');

            markerLayers.end = L.marker([endLat, endLon], {
                icon: L.divIcon({
                    html: "<div style='background:#F44336;width:30px;height:30px;border-radius:50%;border:3px solid white;display:flex;align-items:center;justify-content:center;font-weight:bold;color:white;'>E</div>",
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map).bindPopup('End');

            const colors = { shortest: '#3498db', safest: '#2ecc71', balanced: '#f39c12' };
            const container = document.getElementById('routeCards');
            container.innerHTML = '';
            currentRouteData = routes;

            for (const [type, data] of Object.entries(routes)) {
                if (!data || !data.coordinates) continue;

                const card = document.createElement('div');
                card.className = `route-card ${type}`;
                card.innerHTML = `
                    <div class="route-title">${type} Route</div>
                    <div class="route-info">
                        <div>${data.distance_km.toFixed(2)} km</div>
                        <div>Safety: ${data.safety_score.toFixed(1)}</div>
                        <div><span class="risk-badge risk-${data.risk_level.toLowerCase().replace(' ', '-')}">${data.risk_level}</span></div>
                        <div>${data.num_segments} segments</div>
                    </div>
                `;
                card.onclick = () => toggleRoute(type);
                container.appendChild(card);

                const coords = data.coordinates.map(c => [c.lat, c.lon]);
                routeLayers[type] = L.polyline(coords, {
                    color: colors[type],
                    weight: 6,
                    opacity: 0.8
                });
            }

            document.getElementById('routesResult').classList.remove('hidden');
            
            const allCoords = Object.values(routes)
                .filter(r => r && r.coordinates)
                .flatMap(r => r.coordinates.map(c => [c.lat, c.lon]));
            if (allCoords.length > 0) {
                map.fitBounds(allCoords, { padding: [50, 50] });
            }

            if (routes.safest) {
                renderAnalysis('safest', routes.safest, routes);
            }
        }

        function toggleRoute(type) {
            Object.values(routeLayers).forEach(l => {
                if (map.hasLayer(l)) map.removeLayer(l);
            });
            
            if (routeLayers[type]) {
                routeLayers[type].addTo(map);
                map.fitBounds(routeLayers[type].getBounds(), { padding: [50, 50] });
            }
            
            document.querySelectorAll('.route-card').forEach(c => c.classList.remove('active'));
            event.target.closest('.route-card').classList.add('active');

            if (currentRouteData[type]) {
                renderAnalysis(type, currentRouteData[type], currentRouteData);
            }
        }

        function clearMap() {
            Object.values(routeLayers).forEach(l => { if (map.hasLayer(l)) map.removeLayer(l); });
            Object.values(markerLayers).forEach(m => { if (map.hasLayer(m)) map.removeLayer(m); });
            routeLayers = {};
            markerLayers = {};
            currentRouteData = {};
            document.getElementById('routesResult').classList.add('hidden');
            document.getElementById('analysisSection').classList.add('hidden');
        }

        document.getElementById('initBtn').addEventListener('click', initializeSystem);
        document.getElementById('findRouteBtn').addEventListener('click', findRoutes);
        document.getElementById('clearBtn').addEventListener('click', clearMap);

        window.addEventListener('load', () => {
            initMap();
            fetch(`${API_URL}/api/status`)
                .then(r => r.json())
                .then(data => {
                    if (data.initialized) {
                        initialized = true;
                        updateStatus('System ready!', 'success');
                        document.getElementById('routeInputs').classList.remove('hidden');
                        document.getElementById('initBtn').style.display = 'none';
                    }
                })
                .catch(() => console.log('Server starting...'));
        });
    </script>
</body>
</html>